<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blind 75 Randomizer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      transition: background 0.3s, color 0.3s;
    }

    body.dark {
      background: #121212;
      color: #f0f0f0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      margin-right: 0.5rem;
    }

    .question {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      position: relative;
      transition: background 0.5s ease;
    }

    .completed {
      background-color: #3f9e55 !important;
    }

    .fade {
      animation: fadeHighlight 1.5s ease forwards;
    }

    @keyframes fadeHighlight {
      0% { background-color: #c8facc; }
      100% { background-color: inherit; }
    }

    .note-area {
      display: none;
      margin-top: 0.5rem;
    }

    .note-area textarea {
      width: 100%;
      height: 60px;
      resize: vertical;
    }

    input[type="text"] {
      margin-left: 0.5rem;
      padding: 2px 6px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <button class="btn" id="randomize">üé≤ Randomize</button>
      <button class="btn" id="toggle-theme">üåì Theme</button>
    </div>
  </div>

  <div id="questions"></div>

  <script>
    const questionsDiv = document.getElementById('questions');
    const randomizeBtn = document.getElementById('randomize');
    const toggleThemeBtn = document.getElementById('toggle-theme');

    // Load saved theme from localStorage
    let isDark = localStorage.getItem('theme') === 'dark';
    if (isDark) {
      document.body.classList.add('dark');
    }

    function renderQuestions(questions) {
      questionsDiv.innerHTML = '';
      questions.sort((a, b) => a.number - b.number).forEach(q => {
        const qDiv = document.createElement('div');
        qDiv.className = 'question' + (q.status ? ' completed' : '');
        qDiv.innerHTML = `
          <strong>#${q.number}</strong>
          ${q.name ? `<span> - ${q.name}</span>` : `<input type="text" placeholder="Enter question name" id="name-${q.number}" />`}
          ${!q.status ? `<button class="btn" onclick="markComplete(${q.number}, this)">‚úÖ Complete</button>` : ''}
          <button class="btn" onclick="toggleNote(${q.number})">üìù Note</button>
          <div class="note-area" id="note-${q.number}">
            <textarea onchange="saveNote(${q.number}, this)">${q.note || ''}</textarea>
          </div>
        `;
        questionsDiv.appendChild(qDiv);
      });
    }

    function fetchQuestions() {
      fetch('/questions')
        .then(res => res.json())
        .then(renderQuestions);
    }

    function markComplete(number, btn) {
      fetch('/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number })
      }).then(() => {
        const div = btn.closest('.question');
        div.classList.add('fade');
        setTimeout(() => {
          div.classList.remove('fade');
          fetchQuestions();
        }, 1500);
      });
    }

    function toggleNote(number) {
      const noteBox = document.getElementById(`note-${number}`);
      noteBox.style.display = noteBox.style.display === 'block' ? 'none' : 'block';
    }

    function saveNote(number, textarea) {
      fetch('/note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ number, note: textarea.value })
      });
    }

    randomizeBtn.onclick = () => {
      fetch('/randomize', { method: 'POST' })
        .then(res => res.json())
        .then(() => fetchQuestions());
    };

    toggleThemeBtn.onclick = () => {
      isDark = !isDark;
      document.body.classList.toggle('dark', isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };

    document.addEventListener('click', e => {
      if (e.target.tagName === 'INPUT' && e.target.id.startsWith('name-')) {
        e.target.addEventListener('keydown', function handler(ev) {
          if (ev.key === 'Enter') {
            const number = +e.target.id.split('-')[1];
            fetch('/add-name', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ number, name: e.target.value })
            }).then(fetchQuestions);
          }
        }, { once: true });
      }
    });

    fetchQuestions();
  </script>
</body>
</html>
